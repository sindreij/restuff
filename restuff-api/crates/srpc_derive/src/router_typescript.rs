use change_case::camel_case;
use proc_macro2::TokenStream;
use quote::{quote, quote_spanned};
use syn::{ImplItem, ReturnType};

use crate::zod::fix_typename;

pub(crate) fn generate_router_typescript(parsed_item: &syn::ItemImpl) -> TokenStream {
    let (calls, call_schemas) = parsed_item
        .items
        .iter()
        .filter_map(|item| {
            if let ImplItem::Fn(item) = item {
                if let syn::Visibility::Public(_) = item.vis {
                    Some(item)
                } else {
                    None
                }
            } else {
                None
            }
        })
        .filter_map(|item| {
            let name = &item.sig.ident.to_string();
            let camel_case_name = camel_case(name);
            let schema_name = format!("{}Schema", camel_case_name);
            let ReturnType::Type(typ_token, typ) = &item.sig.output else {return None};
            let typ = fix_typename(typ);
            let typ_span = typ_token.spans[0];

            let call = quote! {
                writeln!(
                    res,
                    "{camel_case_name}: async () => rpcCall('{name}', {schema_name}),",
                    camel_case_name=#camel_case_name,
                    name=#name,
                    schema_name=#schema_name
                ).unwrap();
            };

            let schema = quote_spanned! {typ_span=>
                writeln!(res, "export const {schema_name} = {};\n", #typ::generate_zod_schema(), schema_name=#schema_name).unwrap();
            };

            Some((call, schema))
        }).unzip::<_, _, Vec<_>, Vec<_>>();

    quote! {
        use std::fmt::Write;
        use srpc::ZodSchema;

        let mut res = String::new();


        writeln!(res, "// This file is generated by srpc-derive").unwrap();
        writeln!(res, "").unwrap();
        writeln!(res, "import {{ rpcCall }} from './rpcClient';").unwrap();
        writeln!(res, "import {{ z }} from 'zod';").unwrap();
        writeln!(res, "").unwrap();

        #(#call_schemas)*

        writeln!(res, "export const client = {{").unwrap();

        #(#calls)*

        writeln!(res, "}};\n").unwrap();

        res
    }
}
